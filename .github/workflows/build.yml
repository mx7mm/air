name: Build & Test
on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build Air OS (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64
            defconfig: air_defconfig
            artifact_name: air-disk-image-x86_64
          - target: arm64
            defconfig: air_arm64_defconfig
            artifact_name: air-disk-image-arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git wget cpio python3 unzip rsync bc libncurses5-dev libssl-dev bubblewrap

      - name: Build Air
        run: ./scripts/build.sh
        env:
          AIR_DEFCONFIG: ${{ matrix.defconfig }}
        timeout-minutes: 60

      - name: Check Output
        run: |
          if [ -f "$HOME/air-build/buildroot/output/images/disk.img" ]; then
            ls -lh "$HOME/air-build/buildroot/output/images/disk.img"
          else
            echo "Build failed - no disk.img generated"
            exit 1
          fi

      - name: Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ~/air-build/buildroot/output/images/disk.img
          retention-days: 7
