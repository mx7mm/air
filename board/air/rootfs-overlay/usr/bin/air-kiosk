#!/bin/sh

if [ -x /usr/bin/air-runtime-flags ]; then
	. /usr/bin/air-runtime-flags
fi

VERSION_FILE="${AIR_VERSION_FILE:-/etc/air/VERSION}"

log_runtime() {
	line="$(date '+%Y-%m-%dT%H:%M:%S%z') [air-kiosk] $*"
	if [ -n "${AIR_RUNTIME_LOG:-}" ]; then
		printf '%s\n' "$line" >> "$AIR_RUNTIME_LOG"
	fi
	if [ -n "${AIR_LOG_PERSISTENT_DIR:-}" ] && [ -d "$AIR_LOG_PERSISTENT_DIR" ]; then
		printf '%s\n' "$line" >> "$AIR_LOG_PERSISTENT_DIR/runtime.log"
	fi
}

if [ -z "${AI_VERSION:-}" ]; then
	if [ -r "$VERSION_FILE" ]; then
		AI_VERSION="$(head -n 1 "$VERSION_FILE")"
	else
		AI_VERSION="v0.1.0"
	fi
fi

show_logo() {
	echo "  ___ ___ ___ "
	echo " / _ \\_ _| _ \\"
	echo "|  _/| ||   /"
	echo "|_| |___|_|_\\"
}

show_version() {
	echo "Version: $AI_VERSION"
}

show_features() {
	echo "Neueste Features:"
	echo "- UEFI/GRUB disk image boot"
	echo "- BusyBox init + air-session launcher"
	echo "- ARM64 image boot in QEMU"
	echo "- Runtime flags via /etc/air/runtime.conf"
	echo "- Manuelles Update ueber Befehl: update"
	echo "- AIR_DEBUG=1 -> shell fallback"
	echo "- AIR_REBOOT_ON_EXIT=1 -> force reboot"
}

run_update() {
	if [ ! -x /usr/bin/air-auto-update ]; then
		echo "Update-Tool nicht verfuegbar"
		return 1
	fi
	echo "Suche Update..."
	AIR_AUTO_UPDATE=1 /usr/bin/air-auto-update run || true
	/usr/bin/air-auto-update status || true
}

show_logo
show_version
show_features
echo "Befehle: features, version, update, status, exit"
log_runtime "kiosk started (version=${AI_VERSION})"

while :; do
	printf "air-ai> "
	IFS= read -r cmd || exit 0
	case "$cmd" in
		""|features)
			log_runtime "command=features"
			show_features
			;;
		version)
			log_runtime "command=version"
			show_version
			;;
		update)
			log_runtime "command=update"
			run_update
			;;
		status)
			log_runtime "command=status"
			if [ -x /usr/bin/air-auto-update ]; then
				/usr/bin/air-auto-update status || true
			else
				echo "Kein Update-Status verfuegbar"
			fi
			;;
		help)
			log_runtime "command=help"
			echo "Befehle: features, version, update, status, exit"
			;;
		exit|quit)
			log_runtime "command=exit"
			echo "Bye."
			exit 0
			;;
		*)
			log_runtime "command=unknown value=$cmd"
			echo "Unbekannt: $cmd"
			;;
	esac
done
