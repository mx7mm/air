#!/bin/sh

if [ -x /usr/bin/air-runtime-flags ]; then
	. /usr/bin/air-runtime-flags
fi

VERSION_FILE="${AIR_VERSION_FILE:-/etc/air/VERSION}"

log_runtime() {
	line="$(date '+%Y-%m-%dT%H:%M:%S%z') [air-primary-interface] $*"
	if [ -n "${AIR_RUNTIME_LOG:-}" ]; then
		printf '%s\n' "$line" >> "$AIR_RUNTIME_LOG"
	fi
	if [ -n "${AIR_LOG_PERSISTENT_DIR:-}" ] && [ -d "$AIR_LOG_PERSISTENT_DIR" ]; then
		printf '%s\n' "$line" >> "$AIR_LOG_PERSISTENT_DIR/runtime.log"
	fi
}

show_version() {
	if [ -r "$VERSION_FILE" ]; then
		echo "Version: $(head -n 1 "$VERSION_FILE")"
	else
		echo "Version: unbekannt"
	fi
}

run_update() {
	if [ ! -x /usr/bin/air-auto-update ]; then
		echo "Update-Tool nicht verfuegbar"
		return 1
	fi
	echo "Suche Update..."
	AIR_AUTO_UPDATE=1 /usr/bin/air-auto-update run || true
	if [ -x /usr/bin/air-auto-update ]; then
		/usr/bin/air-auto-update status || true
	fi
	return 0
}

printf '\033c'
echo "Willkommen"
show_version
echo "Befehle: update, status, version, exit"
log_runtime "started"

while :; do
	printf "air> "
	IFS= read -r cmd || exit 0
	case "$cmd" in
		update)
			log_runtime "command=update"
			run_update
			;;
		status)
			log_runtime "command=status"
			if [ -x /usr/bin/air-auto-update ]; then
				/usr/bin/air-auto-update status || true
			else
				echo "Kein Update-Status verfuegbar"
			fi
			;;
		version)
			log_runtime "command=version"
			show_version
			;;
		exit|quit)
			log_runtime "command=exit"
			echo "Bye."
			exit 0
			;;
		help|"")
			log_runtime "command=help"
			echo "Befehle: update, status, version, exit"
			;;
		*)
			log_runtime "command=unknown value=$cmd"
			echo "Unbekannt: $cmd"
			;;
	esac
done
