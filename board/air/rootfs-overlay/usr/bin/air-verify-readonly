#!/bin/sh
# Air Read-Only Verification Script
# Verifies that the root filesystem is mounted read-only
# and that writable tmpfs directories are properly configured

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "=== Air Read-Only Root Verification ==="
echo ""

# Check if root is mounted read-only
ROOT_MOUNT=$(mount | grep "on / " | grep -o "ro\|rw" | head -1)
if [ "$ROOT_MOUNT" = "ro" ]; then
    echo -e "${GREEN}✓${NC} Root filesystem is read-only"
    ROOT_OK=1
else
    echo -e "${RED}✗${NC} Root filesystem is NOT read-only (mounted as: $ROOT_MOUNT)"
    ROOT_OK=0
fi

# Check tmpfs mounts
check_tmpfs() {
    DIR=$1
    if mount | grep -q "tmpfs on $DIR type tmpfs"; then
        echo -e "${GREEN}✓${NC} $DIR is mounted as tmpfs"
        return 0
    else
        echo -e "${RED}✗${NC} $DIR is NOT mounted as tmpfs"
        return 1
    fi
}

echo ""
check_tmpfs "/tmp"
TMP_OK=$?
check_tmpfs "/run"
RUN_OK=$?
check_tmpfs "/var"
VAR_OK=$?

# Test write operations
echo ""
echo "Testing write operations..."

# Test root write (should fail)
if touch /.test-write 2>/dev/null; then
    echo -e "${RED}✗${NC} Root write test: FAILED (write should not be allowed)"
    rm -f /.test-write
    WRITE_TEST_OK=0
else
    echo -e "${GREEN}✓${NC} Root write test: PASSED (write blocked as expected)"
    WRITE_TEST_OK=1
fi

# Test tmpfs write (should succeed)
if touch /tmp/.test-write 2>/dev/null; then
    echo -e "${GREEN}✓${NC} /tmp write test: PASSED"
    rm -f /tmp/.test-write
    TMP_WRITE_OK=1
else
    echo -e "${RED}✗${NC} /tmp write test: FAILED"
    TMP_WRITE_OK=0
fi

if touch /var/log/.test-write 2>/dev/null; then
    echo -e "${GREEN}✓${NC} /var write test: PASSED"
    rm -f /var/log/.test-write
    VAR_WRITE_OK=1
else
    echo -e "${RED}✗${NC} /var write test: FAILED"
    VAR_WRITE_OK=0
fi

# Summary
echo ""
echo "=== Summary ==="
if [ $ROOT_OK -eq 1 ] && [ $TMP_OK -eq 0 ] && [ $RUN_OK -eq 0 ] && [ $VAR_OK -eq 0 ] && \
   [ $WRITE_TEST_OK -eq 1 ] && [ $TMP_WRITE_OK -eq 1 ] && [ $VAR_WRITE_OK -eq 1 ]; then
    echo -e "${GREEN}✓ All checks passed - Read-only root is properly configured${NC}"
    exit 0
else
    echo -e "${RED}✗ Some checks failed - Read-only root may not be properly configured${NC}"
    exit 1
fi
